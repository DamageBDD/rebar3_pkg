#!/bin/sh
set -eu

APP="{{app}}"
PREFIX="{{install_prefix}}"

# Candidate hook directories:
# 1) Optional system hook dir (if you ever stage one)
# 2) The relx app priv path shipped in the package
HOOK_DIRS="
/usr/lib/${APP}/postinst.d
${PREFIX}/lib/${APP}-*/priv/pkg/postinst.d
"

run_hooks_dir() {
  d="$1"
  [ -d "$d" ] || return 0

  # Prefer run-parts if available; fallback to POSIX loop
  if command -v run-parts >/dev/null 2>&1; then
    # run-parts does not expand globs, so iterate matches
    for m in $d; do
      [ -d "$m" ] || continue
      run-parts --exit-on-error "$m"
    done
  else
    for m in $d; do
      [ -d "$m" ] || continue
      for f in "$m"/*; do
        [ -f "$f" ] || continue
        chmod +x "$f" || true
        "$f"
      done
    done
  fi
}

# Execute hooks in order for each candidate directory
for dir in $HOOK_DIRS; do
  run_hooks_dir "$dir"
done

exit 0

